#!groovy

// GIT config -------------------------------------------------------{
def gitRepo = 'https://tools.adidas-group.com/bitbucket/scm/gtt/gtt-b2cc-be.git'
//}
// Jenkins config ---------------------------------------------------{
def testNode = 'docker'
def testSet = 'B2CT-1'
def env='-Denv=sit'
def tags=['@token','@PCAPI_input_smoke_test']
def err
//}

@Library(['global-jenkins-library@master', 'gtt-jenkins-library@master']) _


//Pipeline 
node(testNode) {
	try{
		currentBuild.result = 'SUCCESS'

		stage('Collect info') {
			get.project repo: gitRepo
		}

		stage('GET Xray') {
			features.export key: testSet
		}

		stage('Build') {
			err = test.build()
		}

		stage('Test') {
			err = test.run disableClean: true, testFlags: " -x testClasses -x classes",remote: "http://deheremap7628", aggregateFlags: env, labels: tags, labelAssemble: "or"
		}

		stage('POST Xray') {
			features.importing()
		}

		stage('Publishing Results') {
			report.serenity()
			report.cucumber()
		}
	} catch(e){
		echo "Caught: ${e}"
			currentBuild.result = 'FAILURE'
	} finally {
		if (err) {
			currentBuild.result = 'UNSTABLE'
		}
	}
}
